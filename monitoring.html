<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring â€“ Ramadan Kalender 2026</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Outfit:wght@300;400;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Login Gate -->
    <div class="admin-login" id="adminLogin">
        <h2>ğŸ“Š Projekt-Monitoring</h2>
        <p style="color:var(--text-secondary); font-size:0.85rem; margin-bottom:20px;">
            Dieser Bereich dient der Ãœberwachung der Live-Daten.
        </p>
        <input type="password" id="adminPassword" placeholder="Zugangscode eingeben" autocomplete="current-password">
        <button onclick="checkPassword()" id="loginBtn">Einloggen</button>
        <p id="loginError" style="color:#ff6b6b; font-size:0.82rem; margin-top:10px; display:none;">
            âŒ Falscher Zugangscode
        </p>
    </div>

    <!-- Admin Content (hidden until login) -->
    <div class="admin-page" id="adminContent" style="display:none;">
        <a href="index.html" class="setup-back">â† ZurÃ¼ck zum Kalender</a>

        <div class="admin-header">
            <h1>ğŸ“Š Monitoring-Board</h1>
            <p>Ereignisse und TÃ¼ren im Ãœberblick.</p>
        </div>

        <!-- Stats -->
        <div id="adminStats" style="
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 24px;
        "></div>

        <!-- Doors Grid -->
        <div class="admin-grid" id="adminGrid">
            <!-- Built by JS -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        /* ======================================
           MONITORING PAGE LOGIC
           ====================================== */

        const SUPABASE_URL = 'https://thscbzyzblpqwbskymbg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_w4wZcJW_TOnzxlgr-kMr5Q_aCu8OxTz';

        const ADMIN_PASSWORD_HASH = 'ramadan2026admin';

        let supabaseClient = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) { }

        // Fallback tasks
        const FALLBACK_TASKS = [
            { id: 'f1-1', day: 1, icon: 'ğŸ‘‹', title: 'BegrÃ¼ÃŸung', task: 'Sage â€Ramadan Mubarak!" oder â€HayÄ±rlÄ± Ramazanlar!" zu jedem in deiner Familie.' },
            { id: 'f1-2', day: 1, icon: 'ğŸ§ ', title: 'Verstehen', task: 'Frage deine Eltern: â€Warum fasten Muslime im Ramadan?" und hÃ¶r gut zu.' },
            { id: 'f1-3', day: 1, icon: 'â¤ï¸', title: 'Herzensaufgabe', task: 'Male ein Bild oder zeichne etwas, auf das du dich im Ramadan freust.' }
        ];

        // ========== PASSWORD CHECK ==========
        function checkPassword() {
            const input = document.getElementById('adminPassword').value;
            if (input === ADMIN_PASSWORD_HASH || sessionStorage.getItem('admin_auth') === 'true') {
                sessionStorage.setItem('admin_auth', 'true');
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadAdminData();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('admin_auth') === 'true') {
                checkPassword();
            } else {
                const pwInput = document.getElementById('adminPassword');
                if (pwInput) {
                    pwInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') checkPassword();
                    });
                    pwInput.focus();
                }
            }
        });

        // ========== LOAD DATA ==========
        async function loadAdminData() {
            let tasks = [...FALLBACK_TASKS];

            if (supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('daily_tasks')
                        .select('*')
                        .order('day', { ascending: true });

                    if (!error && data && data.length > 0) {
                        tasks = data;
                    }
                } catch (e) { }

                try {
                    const { count } = await supabaseClient
                        .from('families')
                        .select('*', { count: 'exact', head: true });

                    renderStats(count || 0);
                } catch (e) {
                    renderStats('â€“');
                }
            }

            renderDoors(tasks);
        }

        function renderStats(familyCount) {
            const container = document.getElementById('adminStats');
            if (!container) return;

            const stats = [
                { label: 'Familien registriert', value: familyCount, icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' },
                { label: 'Tage aktiv', value: 30, icon: 'ğŸ—“ï¸' },
                { label: 'System-Status', value: 'Live', icon: 'ğŸŸ¢' }
            ];

            container.innerHTML = stats.map(s => `
                <div style="
                    background: linear-gradient(135deg, var(--bg-accent), var(--bg-mid));
                    border: 1px solid rgba(212,168,67,0.2);
                    border-radius: var(--radius-md);
                    padding: 16px 24px;
                    text-align: center;
                    min-width: 140px;
                ">
                    <div style="font-size: 1.8rem; margin-bottom: 6px;">${s.icon}</div>
                    <div style="font-size: 1.4rem; font-weight: 700; color: var(--gold-light);">${s.value}</div>
                    <div style="font-size: 0.78rem; color: var(--text-secondary);">${s.label}</div>
                </div>
            `).join('');
        }

        function renderDoors(tasks) {
            const grid = document.getElementById('adminGrid');
            if (!grid) return;
            grid.innerHTML = '';

            // Group tasks by day
            const grouped = {};
            tasks.forEach(t => {
                if (!grouped[t.day]) grouped[t.day] = [];
                grouped[t.day].push(t);
            });

            // Iterate through days 1-30
            for (let d = 1; d <= 30; d++) {
                const dayTasks = grouped[d] || [];
                if (dayTasks.length === 0) continue;

                const door = document.createElement('div');
                door.className = 'admin-door';

                let tasksHtml = dayTasks.map(t => `
                    <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="font-weight: 700; color: var(--gold-light); font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                            <span>${t.icon || 'ğŸŒ™'}</span> ${escapeHtml(t.title)}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; margin-top: 4px;">
                            ${escapeHtml(t.task)}
                        </div>
                    </div>
                `).join('');

                door.innerHTML = `
                    <div class="admin-door-header" style="margin-bottom: 15px;">
                        <div class="admin-door-num">${d}</div>
                        <div style="font-family: var(--font-display); font-size: 1.1rem; color: white;">Tag ${d}</div>
                    </div>
                    <div class="admin-door-content">
                        ${tasksHtml}
                    </div>
                `;
                grid.appendChild(door);
            }
        }

        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }
    </script>
</body>

</html>