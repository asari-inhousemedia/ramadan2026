<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitoring ‚Äì Ramadan Kalender 2026</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Outfit:wght@300;400;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Login Gate -->
    <div class="admin-login" id="adminLogin">
        <h2>üìä Projekt-Monitoring</h2>
        <p style="color:var(--text-secondary); font-size:0.85rem; margin-bottom:20px;">
            Dieser Bereich dient der √úberwachung der Live-Daten.
        </p>
        <input type="password" id="adminPassword" placeholder="Zugangscode eingeben" autocomplete="current-password">
        <button onclick="checkPassword()" id="loginBtn">Einloggen</button>
        <p id="loginError" style="color:#ff6b6b; font-size:0.82rem; margin-top:10px; display:none;">
            ‚ùå Falscher Zugangscode
        </p>
    </div>

    <!-- Admin Content (hidden until login) -->
    <div class="admin-page" id="adminContent" style="display:none;">
        <a href="index.html" class="setup-back">‚Üê Zur√ºck zum Kalender</a>

        <div class="admin-header">
            <h1>üìä Monitoring-Board</h1>
            <p>Ereignisse und T√ºren im √úberblick.</p>
        </div>

        <!-- Stats -->
        <div id="adminStats" style="
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 24px;
        "></div>

        <!-- Recent Registrations -->
        <div
            style="max-width: 800px; margin: 0 auto 30px auto; background: rgba(13, 21, 53, 0.4); border-radius: var(--radius-lg); border: 1px solid rgba(212, 168, 67, 0.2); overflow: hidden;">
            <div
                style="padding: 15px 20px; border-bottom: 1px solid rgba(212,168,67,0.1); font-weight: 700; color: var(--gold-light); display: flex; justify-content: space-between; align-items: center;">
                <span>Registered Children & Activity</span>
                <span id="childTotal"
                    style="font-size: 0.8rem; background: var(--bg-accent); padding: 2px 8px; border-radius: 10px; color: white;">...</span>
            </div>
            <div style="max-height: 400px; overflow-y: auto; overflow-x: auto; -webkit-overflow-scrolling: touch;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem; text-align: left;">
                    <thead style="background: rgba(0,0,0,0.2); color: var(--text-secondary); position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 12px 20px;">Family (Short ID)</th>
                            <th style="padding: 12px 20px;">Child Name</th>
                            <th style="padding: 12px 20px;">Stars ‚≠ê</th>
                        </tr>
                    </thead>
                    <tbody id="childrenTableBody">
                        <!-- Built by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="admin-grid" id="adminGrid">
            <!-- Built by JS -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        /* ======================================
           MONITORING PAGE LOGIC
           ====================================== */

        const SUPABASE_URL = 'https://thscbzyzblpqwbskymbg.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_w4wZcJW_TOnzxlgr-kMr5Q_aCu8OxTz';

        const ADMIN_PASSWORD_HASH = 'ramadan2026admin';

        let supabaseClient = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
        } catch (e) { }

        // Fallback tasks
        const FALLBACK_TASKS = [
            { id: 'f1-1', day: 1, icon: 'üëã', title: 'Begr√º√üung', task: 'Sage ‚ÄûRamadan Mubarak!" oder ‚ÄûHayƒ±rlƒ± Ramazanlar!" zu jedem in deiner Familie.' },
            { id: 'f1-2', day: 1, icon: 'üß†', title: 'Verstehen', task: 'Frage deine Eltern: ‚ÄûWarum fasten Muslime im Ramadan?" und h√∂r gut zu.' },
            { id: 'f1-3', day: 1, icon: '‚ù§Ô∏è', title: 'Herzensaufgabe', task: 'Male ein Bild oder zeichne etwas, auf das du dich im Ramadan freust.' }
        ];

        // ========== PASSWORD CHECK ==========
        function checkPassword() {
            const input = document.getElementById('adminPassword').value;
            if (input === ADMIN_PASSWORD_HASH || sessionStorage.getItem('admin_auth') === 'true') {
                sessionStorage.setItem('admin_auth', 'true');
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                loadAdminData();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('admin_auth') === 'true') {
                checkPassword();
            } else {
                const pwInput = document.getElementById('adminPassword');
                if (pwInput) {
                    pwInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') checkPassword();
                    });
                    pwInput.focus();
                }
            }
        });

        // ========== LOAD DATA ==========
        async function loadAdminData() {
            let tasks = [...FALLBACK_TASKS];

            if (supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('daily_tasks')
                        .select('*')
                        .order('day', { ascending: true });

                    if (!error && data && data.length > 0) {
                        tasks = data;
                    }
                } catch (e) { }

                try {
                    // Fetch all families to analyze setup state
                    const { data: families } = await supabaseClient
                        .from('families')
                        .select('children');

                    // Fetch progress to see active kids & stars
                    const { data: progressList } = await supabaseClient
                        .from('progress')
                        .select('family_id, child_name, completed_tasks');

                    const totalReg = families ? families.length : 0;
                    const setupDone = families ? families.filter(f => f.children && f.children.length > 0).length : 0;
                    const childCount = progressList ? progressList.length : 0;

                    renderStats(totalReg, setupDone, childCount);
                    renderChildrenList(progressList || []);
                } catch (e) {
                    console.error('[Admin] Stats load error:', e);
                    renderStats('‚Äì', '‚Äì', '‚Äì');
                }
            }

            renderDoors(tasks);
        }

        function renderChildrenList(list) {
            const body = document.getElementById('childrenTableBody');
            const total = document.getElementById('childTotal');
            if (!body) return;

            if (total) total.textContent = `${list.length} Kinder`;

            if (list.length === 0) {
                body.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: var(--text-secondary);">Noch keine Kinder registriert.</td></tr>';
                return;
            }

            body.innerHTML = list.map(item => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                    <td style="padding: 12px 20px; color: var(--text-secondary); font-family: monospace;">${item.family_id.substring(0, 8)}...</td>
                    <td style="padding: 12px 20px; color: white; font-weight: 600;">${escapeHtml(item.child_name)}</td>
                    <td style="padding: 12px 20px; color: var(--gold-light); font-weight: 700;">${(item.completed_tasks || []).length}</td>
                </tr>
            `).join('');
        }

        function renderStats(totalReg, setupDone, childCount) {
            const container = document.getElementById('adminStats');
            if (!container) return;

            const stats = [
                { label: 'Registrierungen (Total)', value: totalReg, icon: 'üìß' },
                { label: 'Eingerichtete Familien', value: setupDone, icon: 'üè†' },
                { label: 'Kinder Gesamt', value: childCount, icon: 'üßí' },
                { label: 'Status', value: 'Live', icon: 'üü¢' }
            ];

            container.innerHTML = stats.map(s => `
                <div style="
                    background: linear-gradient(145deg, rgba(26, 37, 96, 0.9), rgba(17, 26, 66, 0.95));
                    border: 1px solid rgba(212,168,67,0.22);
                    border-radius: var(--radius-md);
                    padding: 16px 15px;
                    text-align: center;
                    min-width: 120px;
                    flex: 1;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                ">
                    <div style="font-size: 1.4rem; margin-bottom: 4px;">${s.icon}</div>
                    <div style="font-size: 1.4rem; font-weight: 800; color: var(--gold-light);">${s.value}</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); font-weight: 500; line-height: 1.2;">${s.label}</div>
                </div>
            `).join('');
        }

        function renderDoors(tasks) {
            const grid = document.getElementById('adminGrid');
            if (!grid) return;
            grid.innerHTML = '';

            // Group tasks by day
            const grouped = {};
            tasks.forEach(t => {
                if (!grouped[t.day]) grouped[t.day] = [];
                grouped[t.day].push(t);
            });

            // Iterate through days 1-30
            for (let d = 1; d <= 30; d++) {
                const dayTasks = grouped[d] || [];
                if (dayTasks.length === 0) continue;

                const door = document.createElement('div');
                door.className = 'admin-door';

                let tasksHtml = dayTasks.map(t => `
                    <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="font-weight: 700; color: var(--gold-light); font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                            <span>${t.icon || 'üåô'}</span> ${escapeHtml(t.title)}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); line-height: 1.4; margin-top: 4px;">
                            ${escapeHtml(t.task)}
                        </div>
                    </div>
                `).join('');

                door.innerHTML = `
                    <div class="admin-door-header" style="margin-bottom: 15px;">
                        <div class="admin-door-num">${d}</div>
                        <div style="font-family: var(--font-display); font-size: 1.1rem; color: white;">Tag ${d}</div>
                    </div>
                    <div class="admin-door-content">
                        ${tasksHtml}
                    </div>
                `;
                grid.appendChild(door);
            }
        }

        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }
    </script>
</body>

</html>